<!DOCTYPE html>
<meta charset="utf-8">
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
<script th:inline="javascript" th:if="${session.member}">
    const USER_SEQ = [[${session.member.seq}]];
    const USER_NAME = [[${session.member.memberName}]];
    const USER_ROLE = [[${session.member.memberRole}]];

    var socket = null;
    $(document).ready(function(){
        connectWs();
    })

    function connectWs(){
        console.log("연결");
        var ws = new SockJS('/alarm');
        socket = ws;
        ws.onopen = function (){
            console.log("open")
        };

        ws.onmessage = function (event){
            console.log("onmessage 실행")
            console.log("onmessage"+event.data);
            let htmlAlarm = '';
            $('#real-time-notice').html(event.data);
            $('#real-time-notice').css('display', 'block');

            setTimeout(function(){
                $('#real-time-notice').css('display','none');

            }, 5000);
        };
        ws.onclose = function() {
            console.log("onclose 실행")
            console.log('close');
        };
    }


</script>
<!------ Include the above in your HEAD tag ---------->

<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>MODU - 5000만 국민의 선택</title>
    <!--Made with love by Mutiullah Samim -->

    <!--Bootsrap 4 CDN-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <!--Fontawesome CDN-->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">

    <!--Custom styles-->
    <link rel="stylesheet" type="text/css" href="../static/css/Main2.css">
</head>
<header class="masthead">
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" id="mainNav">
        <div class="container">
            <a class="navbar-brand" href="../MainForm"><img src="../static/assets/MODU.PNG" alt="..." /></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                Menu
                <i class="fas fa-bars ms-1"></i>
            </button>

            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav text-uppercase ms-auto py-4 py-lg-0">
                    <th:block th:unless="${session.member}">
                        <script>
                            var result = confirm("로그인이 필요한 서비스입니다.");

                            if(result)
                            {
                                window.location.href="../LoginForm";

                            }
                            else
                            {
                                window.location.href="../MainForm";
                            }
                        </script>
                    </th:block>
                    <th:block th:if="${session.member}">
                        <li class="nav-item"><a class="nav-link" href="#services">카테고리</a></li>
                        <li class="nav-item"><a class="nav-link" href="../board/Post">커뮤니티</a></li>
                        <li th:if="${session.member.memberRole} == 'Professor'" class="nav-item"><a class="nav-link" href="commission/Form">제안</a></li>
                        <li th:if="${session.member.memberRole} == 'Student'" class="nav-item"><a class="nav-link" href="commission/Find">교수찾기</a></li>
                        <li class="nav-item"><a class="nav-link" href="../MyPage"><td th:text="${session.member.id}"></td>님</a></li>
                        <li class="nav-item"><a class="nav-link" href="../Logout">로그아웃</a></li>
                    </th:block>
                </ul>
            </div>

        </div>

    </nav>
</header>
<body>
<tbody>
<div class="category_card">
    <div class="list_detail">
        <div class="detail">
            <strong id="detail_font1" th:utext="${list.title}"></strong>
        </div>
        <div class="detail_btn"><h4><b>상세 살명</b></h4><br>
        </div>
        <hr width="100%" color=#b4adad>

        <strong id="detail_font2" th:utext="${list.content}"></strong>
    </div>
</div>
<div id="sideNav">
    <th:block th:if="${session.member.memberRole.toString().equals('Professor') and session.member.memberName.equals(list.writer)}">
        <div class="list_chat">
            <input type="button" th:onclick="|location.href='@{../chat/room}'|" class="btn1" id="receive-btn" value="수락요청 보내기">
            <input type="button" class="setBtn" onclick="location.href='./delete/'+list.pcSeq" value="삭제">
            <input type="button" class="setBtn" onclick="location.href='./updateForm/'+list.pcSeq" value="수정">
        </div>

    </th:block>
    <th:block th:if="${session.member.memberRole.toString().equals('Student')}">
        <div class="list_chat">
            <input type="button" class="btn1" id="notice-btn" onclick="commissionNotice()" value="문의 보내기">
        </div>
    </th:block>
</div>
</tbody>
<!--실시간 알림-->
<div id="real-time-notice"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    const seq = '[[${session.member.seq}]]';
    const writer = '[[${session.member.memberName}]]';
    const commissionWriter = '[[${list.writer}]]'
    const pcSeq = [[${list.pcSeq}]];
    const pcTitle = '[[${list.title}]]';
    const pcCategory = '[[${list.category}]]';

    function commissionNotice(insertData){
        console.log("commission",socket)
        $.ajax({
            url:'notice',
            type: 'post',
            data:insertData,
            processData: false, contentType: false,
            enctype : 'multipart/form-data',
            success: function (data){
                if(writer != commissionWriter){
                    if(socket){
                        let socketMsg = "commission"+","+writer+","+commissionWriter+","+pcSeq+","+pcTitle+","+pcCategory;
                        console.log(socketMsg);
                        socket.send(socketMsg);
                    }
                }
            },
            errors:function(){
                console.log("실패");
            }
        })
    }
    //알람 DB 저장
    $('#notice-btn').click(function (){
        console.log('알람 DB 저장');
        $.ajax({
            type:'post',
            url:'../noticeSave',
            data: JSON.stringify({
                "memberSeq":seq,
                "typeSeq" : pcSeq,
                "writeType":'commission',
                "userWriter" : writer,
                "writer": commissionWriter,
                "title": pcTitle,
                "category": pcCategory,
            }),
            contentType: 'application/json',
            success:function (data){
                console.log('통신성공' + data);
                alert("알람 저장 완료!");

            },
            error:function (){
                alert("통신실패"+data);
            }
        });
    });
</script>
</body>
</html>


